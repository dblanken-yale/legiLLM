services:
  # Main persistent container
  legiscan-pipeline:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: legiscan-pipeline
    environment:
      # API Keys (loaded from .env file)
      - PORTKEY_API_KEY=${PORTKEY_API_KEY}
      - LEGISCAN_API_KEY=${LEGISCAN_API_KEY}
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AZURE_OPENAI_DEPLOYMENT=${AZURE_OPENAI_DEPLOYMENT}
      - LLM_PROVIDER=${LLM_PROVIDER:-portkey}
      - LLM_MODEL=${LLM_MODEL}
      - LLM_BASE_URL=${LLM_BASE_URL}

      # Test mode settings
      - TEST_MODE=${TEST_MODE:-false}
      - TEST_COUNT=${TEST_COUNT:-5}

      # Storage backend
      - STORAGE_BACKEND=local
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app

    volumes:
      # Mount local data directory for persistence
      - ./data:/app/data

      # Mount source code for development (optional - comment out for production)
      - ./src:/app/src
      - ./scripts:/app/scripts
      - ./prompts:/app/prompts
      - ./config.json:/app/config.json

    working_dir: /app

    # Keep container running for interactive use
    stdin_open: true
    tty: true

    # Override default command to keep container alive
    command: tail -f /dev/null

    networks:
      - legiscan-network

  # Convenience services - just extend the main service with different commands
  fetch:
    extends: legiscan-pipeline
    container_name: fetch
    profiles: ["cli"]
    entrypoint: ["python", "scripts/fetch_legiscan_bills.py"]

  filter:
    extends: legiscan-pipeline
    container_name: filter
    profiles: ["cli"]
    entrypoint: ["/bin/bash", "-c"]
    command: ["cd scripts && python run_filter_pass.py $${FILE:-}"]

  analyze:
    extends: legiscan-pipeline
    container_name: analyze
    profiles: ["cli"]
    entrypoint: ["/bin/bash", "-c"]
    command: ["cd scripts && python run_analysis_pass.py"]

  direct-analyze:
    extends: legiscan-pipeline
    container_name: direct-analyze
    profiles: ["cli"]
    entrypoint: ["python", "scripts/run_direct_analysis.py"]

networks:
  legiscan-network:
    driver: bridge
